let api = (function () {
  "use strict";

  let module = {};

  // rewrite to use Fetch API and Forms
  function sendFiles(method, url, data, callback) {
    let formdata = new FormData();
    Object.keys(data).forEach(function (key) {
      let value = data[key];
      formdata.append(key, value);
    });
    let xhr = new XMLHttpRequest();
    xhr.onload = function () {
      if (xhr.status !== 200)
        callback("[" + xhr.status + "]" + xhr.responseText, null);
      else callback(null, JSON.parse(xhr.responseText));
    };
    xhr.open(method, url, true);
    xhr.send(formdata);
  }

  function send(method, url, data, callback) {
    let xhr = new XMLHttpRequest();
    xhr.onload = function () {
      if (xhr.status !== 200)
        callback("[" + xhr.status + "]" + xhr.responseText, null);
      else callback(null, JSON.parse(xhr.responseText));
    };
    xhr.open(method, url, true);
    if (!data) xhr.send();
    else {
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.send(JSON.stringify(data));
    }
  }

  module.addUser = function (username, picture, callback) {
    sendFiles(
      "POST",
      "/api/users/",
      { username: username, picture: picture },
      function (err, res) {
        if (err) return callback(err);
        return callback(null);
      }
    );
  };

  module.getUsers = function (callback) {
    send("GET", "/api/users/", null, callback);
  };

  return module;
})();
